# Configuration for AI Module

# Camera Settings - Hikvision IDS-2CD7146G0-IZS (4MP DeepinView)
camera:
  # RTSP URL format for Hikvision: rtsp://username:password@ip:554/Streaming/Channels/101
  # Channel 101 = Main stream (4MP), 102 = Sub stream (D1/CIF)
  type: "hikvision"

  # Default settings for all cameras
  port: 554
  username: "admin"
  password: "test@2025"
  channel: 1

  # Stream selection:
  # 1 = Main stream: 2560x1440 (4MP), H.265+, best quality for recording
  # 2 = Sub stream: 704x576 (D1), faster processing, recommended for AI
  stream: 1 # Main stream for better quality

  # Native resolution của camera
  width: 1920
  height: 1080
  fps: 25

  # Processing resolution (resize để AI xử lý nhanh hơn)
  process_width: 960
  process_height: 540

  # Connection optimization
  reconnect_delay: 3
  max_reconnect_attempts: 15
  buffer_size: 0 # ZERO buffer for real-time
  connection_timeout: 10 # Timeout kết nối (giây)
  read_timeout: 5 # Timeout đọc frame (giây)

  # RTSP Transport
  # tcp = ổn định hơn, udp = latency thấp hơn
  transport: "udp" # UDP for lower latency

  # Hardware acceleration (GTX 1650 4GB)
  use_hw_accel: true # ENABLED for NVIDIA GPU
  hw_decoder: "cuda" # cuda, dxva2, d3d11va

  # Fallback options
  fallback_source: 0

  # Camera list
  cameras:
    - id: "main_entrance"
      name: "Lối vào chính"
      ip: "192.168.1.6"
      stream_path: "/Streaming/Channels/101"
      enabled: true

# Face Recognition Settings (GPU Optimized for GTX 1650)
face_recognition:
  enabled: true
  use_gpu: true # Enable GPU acceleration
  model: "cnn" # "cnn" for GPU (faster), "hog" for CPU
  tolerance: 0.6 # Similarity threshold for matching
  num_jitters: 1 # Higher = more accurate but slower
  encoding_model: "large" # "small" or "large"
  min_face_size: 120 # Only detect close faces (performance optimization)
  detection_interval: 10 # Process every 10 frames (performance optimization)
  process_scale: 0.5 # Reduce resolution for faster processing
  batch_size: 4 # Process multiple faces at once

# Fall Detection Settings (GPU Optimized for GTX 1650)
fall_detection:
  enabled: true
  use_gpu: true # Enable CUDA
  device: "cuda:0" # Use first GPU
  model_path: "yolov8s-pose.pt" # Small model - cân bằng tốt cho GTX 1650
  # Options: yolov8n-pose.pt (fast, weak), yolov8s-pose.pt (balanced - KHUYẾN NGHỊ),
  #          yolov8m-pose.pt (accurate but LAG), yolov8l-pose.pt (very slow)
  conf_threshold: 0.25 # GIẢM từ 0.4 → 0.25 để detect tốt hơn khi té (keep tracking)
  iou_threshold: 0.45 # NMS threshold
  half_precision: true # FP16 for faster inference on GTX 1650

  # Advanced detection settings (Tối ưu cho performance)
  imgsz: 480 # Input size - giảm từ 640 xuống 480 để tăng tốc 30-40%
  max_det: 3 # Maximum detections - giảm từ 5 xuống 3 (chỉ cần 1-2 người)
  agnostic_nms: false # Class-agnostic NMS
  retina_masks: false # High-resolution masks

  # Fall detection parameters
  model_complexity: 1 # 0, 1, or 2 (higher = more accurate but slower)
  min_detection_confidence: 0.7
  min_tracking_confidence: 0.5
  fall_threshold:
    vertical_speed: 0.08 # GIẢM từ 0.1 → 0.08 để nhạy hơn
    angle_threshold: 70 # GIẢM từ 80 → 70 độ để bắt được té chậm
    duration_threshold: 0.05 # GIẢM từ 0.1 → 0.05s để phản ứng nhanh hơn
  cooldown_seconds: 5 # Về lại 5s (10s quá lâu)
  max_missing_frames: 15 # GIẢM từ 100 → 15 (nếu mất quá nhiều frame = không còn ý nghĩa)

  # Motion-based detection (DISABLED - không hiệu quả)
  motion_threshold: 0.05
  use_motion_fallback: false # TẮT HOÀN TOÀN - chỉ dùng pose-based

# API Settings
api:
  backend_url: "http://localhost:5000"
  websocket_url: "ws://localhost:5000/ws"
  timeout: 5

# Database Settings (for local testing)
database:
  type: "postgresql" # "postgresql" or "sqlserver"
  host: "localhost"
  port: 5432
  name: "hospital_db"
  user: "admin"
  password: "admin123"

# Logging
logging:
  level: "INFO"
  file: "logs/ai_module.log"
